# Player Identity Persistence Fix

## Problem
Player IDs were being generated with `Date.now()` in an in-memory repository, causing them to change on every server restart. This broke authorization checks because:
1. Games stored player IDs in the database
2. Player identities were stored in RAM
3. On restart, new player IDs were generated for the same Clerk users
4. Authorization failed: "Forbidden: Not a participant in this game"

## Solution
Replaced `InMemoryPlayerIdentityRepository` with `PostgresPlayerIdentityRepository` to persist player identities across restarts.

## Changes Made

### 1. Created PlayerIdentityRepository Interface
**File:** `src/domain/interfaces/PlayerIdentityRepository.ts`
- Defines contract for player identity persistence
- Methods: `findByExternalId`, `create`, `getOrCreate`, `findAll`, `findByName`

### 2. Created PostgresPlayerIdentityRepository
**File:** `src/infrastructure/persistence/PostgresPlayerIdentityRepository.ts`
- Implements `PlayerIdentityRepository` interface
- Persists to `player_identities` table (created by migration 003)
- Uses UUID primary keys generated by PostgreSQL
- Maintains unique constraint on (external_auth_provider, external_auth_id)

### 3. Updated InMemoryPlayerIdentityRepository
**File:** `src/infrastructure/persistence/InMemoryPlayerIdentityRepository.ts`
- Now implements `PlayerIdentityRepository` interface
- Kept for backward compatibility and testing

### 4. Updated ClerkAuthenticationService
**File:** `src/adapters/rest/auth/clerk/ClerkAuthenticationService.ts`
- Changed to accept `PlayerIdentityRepository` interface instead of concrete type
- No logic changes

### 5. Updated clerkMiddleware
**File:** `src/adapters/rest/auth/clerkMiddleware.ts`
- Now accepts `PlayerIdentityRepository` as parameter
- Uses injected repository instead of creating its own

### 6. Updated createApp
**File:** `src/adapters/rest/app.ts`
- Accepts `PlayerIdentityRepository` parameter
- Passes repository to `clerkMiddleware`
- Throws error if auth enabled but no repository provided

### 7. Updated Main Application
**File:** `src/index.ts`
- Creates `PostgresPlayerIdentityRepository` when DATABASE_URL is configured
- Throws error if DATABASE_URL is missing (required for persistence)
- Passes repository to `createApp`
- Closes repository connections on graceful shutdown

### 8. Updated Player Routes
**File:** `src/adapters/rest/playerRoutes.ts`
- Changed to accept `PlayerIdentityRepository` interface

## Database Schema
The `player_identities` table (migration 003) has:
- `id` (UUID, primary key, auto-generated)
- `name` (VARCHAR)
- `external_auth_provider` (VARCHAR, nullable)
- `external_auth_id` (VARCHAR, nullable)
- `email` (VARCHAR, nullable)
- `created_at` (TIMESTAMP)
- `last_used` (TIMESTAMP)

Unique index on (external_auth_provider, external_auth_id) ensures one player per Clerk account.

## Testing
After deployment:
1. Verify migration 003 runs successfully
2. Check `player_identities` table exists
3. Sign in with Clerk - should create player identity
4. Restart server
5. Sign in again - should use same player ID
6. Join games and make moves - authorization should work across restarts

## Rollback
If issues occur, revert to in-memory storage by:
1. Reverting changes to `src/index.ts`
2. Using `InMemoryPlayerIdentityRepository` instead
3. Note: This will lose player identity persistence
